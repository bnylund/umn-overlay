
<link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,400;0,600;0,800;0,900;1,400;1,600;1,800&display=swap" rel="stylesheet">
<style>
    @font-face {
        font-family: match;
        src: url(./img/building.ttf);
    }
    #match-boost {
        width: 260px;
        height: 260px;
        border: none;
        bottom: -20px;
        right: -20px;
        z-index: 9;
        position: absolute;
        background-color: rgba(0, 0, 0, 0);
        margin: 0px auto;
        overflow: hidden;

        transform: scale(0.8);
        transform-origin: 0 0;
    }
    #match-details {
        display: flex;
        flex-direction: column;
        width: 270px;
        position: absolute;
        top: 30px;
        left: 30px;
        box-shadow: 2px 2px 10px black;
        line-height: 1;
    }
    #match-speeddiv {
        justify-content: center;
        align-content: center;
        background-color: black;
        margin-top: -40px;
        transition: margin-top 1s;
    }
    #match-speeddiv > p {
        color: white;
        font-family: match;
        font-size: 26px;
        margin-bottom: 0;
        padding: 5px 0;
        background-color:black;
        text-align: center;
    }
    #match-clockdiv {
        justify-content: center;
        align-content: center;
        background-color: black;
        margin-bottom: -70px;
        transition: margin-bottom 1s;
    }
    #match-clockdiv > p {
        color: white;
        font-family: 'Montserrat', sans-serif;
        font-weight: 600;
        font-size: 36px;
        margin-bottom: 0;
        padding: 10px 0;
        background-color: black;
        text-align: center;
    }
    #match-hteam {
        /*background-color: #7a0019;
        color: #ffcc33;*/
        background-color: #F00;
        color: white;
    }
    #match-ateam {
        background-color: #F00;
        color: white;
    }
    .match-team {
        height: 70px;
        display: flex;
        position: relative;
        flex-direction: row;
        overflow: hidden;
    }
    .match-team > div {
        width: 80%;
    }
    .match-team > img {
        opacity: .3;
        z-index: 2;
        position: absolute;
        top: 0;
        right: -30;
        height: 100%;
        object-fit: contain;
        width: 115px;
    }
    .match-team > p {
        font-family: match;
        font-size: 60px;
        font-weight: 600;
        z-index: 3;
        margin: 0;
        position: absolute;
        right: 20px;
    }
    .match-team > div > p {
        font-family: match;
        font-size: 40px;
        margin: 0;
        margin-left: 10px;
        padding-top: 5px;
    }
    .match-series-div {
        height: 20%;
        display: flex;
        flex-direction: row;
        margin-left: 10px;
        margin-top: 3px;
    }
    .match-series-active {
        background-color: yellow;
        box-shadow: 0 0 5px 2px yellow;
        margin-right: 5px;
    }
    .match-series-inactive {
        margin-right: 5px;
        background-color: rgb(126, 98, 6);
        box-shadow: 0px 0px 15px rgb(212, 163, 3) inset;
    }
    .match-series {
        width: 25px;
        height: 5px;
    }
    #match-boost .col > p, #match-replay .col > p {
        color: white;
        font-size: 40px;
        font-family: 'Montserrat', sans-serif;
    }
    .match-event {
        margin-top: 15px;
        text-transform: uppercase;
        background-color: black;
        max-height: 80px;
        display: flex;
        flex-direction: row;
        justify-content: space-evenly;
        min-width:0;
        border-radius: 6px;
    }
    .match-event p {
        color: white;
        font-family: 'Montserrat';
        font-size: 24px;
        margin: 0;
        padding: 5px 10px;
    }
    .match-event-name {
        background-color: black;
        font-weight: 600;
    }
    #match-statfeed {
        max-width: 750px;
        max-height: 1080px;
        border: none;
        position: absolute;
        top: 30px;
        right: 30px;
        background-color: rgba(0, 0, 0, 0);
        overflow: hidden;

        display: flex;
        flex-direction: column;
        align-content: flex-end;
        justify-content: flex-start;
        align-items: flex-end;
    }
    #match-player { 
        width: 450px;
        position: absolute;
        bottom: 30px;
        left: 30px;
        background-color: #7a0019;
        color: #ffcc33;
        border-radius: 4px;
        box-shadow: 2px 2px 10px black
    }
    #match-player > div {
        position: relative;
    }
    #match-player > img {
        width: 180px;
        position: absolute;
        bottom: 105px;
        left: 20px;
        object-fit: contain;
    }
    #match-player > p {
        white-space: nowrap;
        word-wrap: break-word;
        overflow: hidden;
        max-height: 32px;
        margin-top: 10px;
        margin-bottom: 10px;
        margin-left: 220px;
        font-size: 26px;
        font-family: 'Montserrat';
    }
    #match-player-tags {
        background-color: #ffcc33;
        color: #7a0019;
        display: flex;
        flex-direction: row;
        justify-content: space-evenly;
    }
    #match-player-tags p {
        font-size: 18px;
        width: 20%;
        text-align: center;
        margin: 5px 0;
        font-family: 'Montserrat';
        font-weight: 600;
    }
    #match-player-details {
        display: flex;
        color: #ffcc33;
        flex-direction: row;
    }
    #match-player-details p {
        font-size: 38px;
        text-align: center;
        width: 20%;
        margin: 0;
        padding: 0;
        margin-bottom: 10px;
    }
    .match-border {
        border-top-right-radius: 6px;
        border-bottom-right-radius: 6px;
    }
</style>

<rl-scene hidden name="MATCH" show-event="game:initialized" hide-event="game:match_ended" hide-delay="7000">

    <!-- needs scorebug, statfeed, playerview, boost, replayview -->
    <div id="match-details" style="display: none;">
        <div id="match-clockdiv">
            <p id="match-clockp">5:00</p>
        </div>
        <div id="match-hteam" class="match-team">
            <div>
                <p>ERROR</p>
                <div class="match-series-div" id="match-hteam-series">
                    <!--<div class="match-series match-series-inactive"></div>-->
                </div>
            </div>
            <p>0</p>
            <img src="./img/error.png" style="filter: drop-shadow(0 0 .5rem #fff)" />
        </div>
        <div id="match-ateam" class="match-team">
            <div>
                <p>ERROR</p>
                <div class="match-series-div" id="match-ateam-series">
                    <!--<div class="match-series match-series-inactive"></div>-->
                </div>
            </div>
            <p>0</p>
            <img src="./img/error.png" style="filter: drop-shadow(0 0 .5rem #fff)" />
        </div>
        <div id="match-speeddiv">
            <p id="match-goal-speed">Goal Speed: 0 MPH</p>
        </div>
    </div>
    <div id="match-player">
        <!--<img src="./img/umn.png" alt="" />
        <p>PLAYER NAME</p>
        <div id="match-player-tags">
            <p>GOALS</p>
            <p>ASSISTS</p>
            <p>SAVES</p>
            <p>SHOTS</p>
            <p>SCORE</p>
        </div>
        <div id="match-player-details">
            <p>0</p>
            <p>0</p>
            <p>0</p>
            <p>0</p>
            <p>0</p>
        </div>-->
    </div>
    <div id="match-boost" style="display: none;min-width:200px;min-height:200px;">
        <match-boost stroke="15" progress="100" radius="140" teamlogo="./img/umn.png" primarycolor="#FF0000" secondarycolor="#550000" boost="100"></match-boost>
    </div>
    <div id="match-statfeed" class="container">
        <!--<div class="match-event">
            <p>BISMO</p>
            <p class="match-event-name match-border">SHOT</p>
        </div>
        <div class="match-event">
            <p>PHAT</p>
            <p class="match-event-name">DEMO</p>
            <p style="background-color: #0064b1" class="match-border">BOOMER</p>
        </div>-->
    </div>
</rl-scene>

<script>
    class MatchBoost extends HTMLElement {
        constructor() {
            super();
            const stroke = this.getAttribute('stroke');
            const radius = this.getAttribute('radius');
            const team_logo = this.getAttribute('teamlogo');
            const primary_color = this.getAttribute('primarycolor');
            const secondary_color = this.getAttribute('secondarycolor');
            const boost = this.getAttribute('boost');
            const normalizedRadius = radius - stroke * 2;
            this._circumference = normalizedRadius * 2 * Math.PI;

            this._root = this.attachShadow({mode: 'open'});
            this._root.innerHTML = `
            <svg height="${radius * 2}" width="${radius * 2}">
                <image href="${team_logo}" alt="" height="${Number(radius)+60}" width="${Number(radius)+60}" x="${(Number(radius)-60)/2}" y="${(Number(radius)-60)/2}" style="opacity:0.2;object-fit:contain;"/>
                <circle id="match-backring" stroke="#000000aa" stroke-dasharray="${this._circumference} ${this._circumference}" style="stroke-dashoffset:0" stroke-width="${stroke}" fill="transparent" r="${normalizedRadius}" cx="${radius}" cy="${radius}" />
                <circle id="match-ring" stroke="${primary_color}" stroke-dasharray="${this._circumference} ${this._circumference}" style="stroke-dashoffset:${this._circumference}" stroke-width="${stroke}" fill="transparent" r="${normalizedRadius}" cx="${radius}" cy="${radius}" />
                <circle id="match-team-secondary" cx="50%" cy="50%" r="${normalizedRadius-(stroke/2)}" fill="${secondary_color}99" />
                <text x="50%" y="50%" text-anchor="middle" fill="white" font-size="75px" font-family="Arial" style="text-shadow: 1px 1px 10px black;" dy=".3em">${boost}</text>
            </svg>

            <style>
                match-boost svg {
                    background-color: #00000000;
                }
                #match-backring, #match-ring, #match-team-secondary {
                    transition: stroke-dashoffset 0.1s;
                    transform: rotate(-90deg);
                    transform-origin: 50% 50%;
                }
            </style>
            `;
        }
        
        setProgress(percent) {
            const offset = this._circumference - (percent / 100 * this._circumference);
            const circle = this._root.querySelector('#match-ring');
            circle.style.strokeDashoffset = offset; 
            this._root.querySelector('text').innerHTML = percent;
        }

        setTeamLogo(href) {
            this._root.querySelector('image').setAttribute('href', href);
        }

        setPrimaryColor(color){
            this._root.querySelector("#match-ring").setAttribute('stroke', color);
        }

        setSecondaryColor(color){
            this._root.querySelector('#match-team-secondary').setAttribute('fill', color + "99");
        }

        setBoost(amount){
            this._root.querySelector('text').innerHTML = amount;
            this.setProgress(amount);
        }

        static get observedAttributes() {
            return ['progress'];
        }

        attributeChangedCallback(name, oldValue, newValue) {
            if (name === 'progress') {
                this.setProgress(newValue);
                this._root.querySelector('text').innerHTML = newValue;
            } else if(name === 'teamlogo') {
                this._root.querySelector('image').src = newValue;
            } else if(name == 'primarycolor') {
                this._root.querySelector("#match-ring").stroke = newValue;
            } else if(name == 'secondarycolor') {
                this._root.querySelector('#match-team-secondary').fill = newValue + "99";
            } else if(name == 'boost') { 
                this._root.querySelector('text').innerHTML = newValue;
                this.setProgress(newValue);
            }
        }
    }
    window.customElements.define('match-boost', MatchBoost);

    let match_lastGoal = "";

    function secondsToTime(seconds, showMs) {
        //return (new Date((seconds) * 1000)).toISOString().substr(showMs ? 17 : 15, 4);
        var clock_string = "";
        if(!showMs){
            var date = new Date(Math.ceil(seconds) * 1000);
            clock_string += date.getMinutes() + ":" + (date.getSeconds() < 10 ? "0" + date.getSeconds() : date.getSeconds());
        } else {
            var date = new Date(seconds * 1000);
            clock_string += date.getSeconds() + "." + date.getMilliseconds().toString().substr(0, 1);
        }
        return clock_string;
    }

    let lastGame = {};

    let match_displayConversionMap = {
        "Shot on Goal": "Shot",
        "Demolition": "Demo",
        "Clear Ball": "Clear",
    }

    var match_homeTeamPrimary = "#0099FF";
    var match_awayTeamPrimary = "#FF9900";
    var match_homeTeamSecondary = "#FFFFFF";
    var match_awayTeamSecondary = "#FFFFFF";
    var match_lastGoalSpeed = 0;

    function findPlayer(id) {
        let player = {};
        let team = "";
        Object.values(lastGame["homeTeam"]["players"]).forEach((entry) => {
            if(entry["id"] === id) {
                player = entry;
                team = "homeTeam";
            }
        });
        Object.values(lastGame["awayTeam"]["players"]).forEach((entry) => {
            if(entry["id"] === id) {
                player = entry;
                team = "awayTeam";
            }
        });
        return {player: player, team: team};
    }

    function random(min, max) {
        return Math.floor(Math.random() * (max - min) ) + min;
    }

    function addEvent(player, team_color, stat){
        var html = `
            <p style="background-color: ${team_color} !important;">${player}</p>
            <p class="match-event-name match-border">${stat}</p>`;

        var child = document.createElement('div');
        child.classList.add('match-event');
        child.innerHTML = html;
        document.getElementById('match-statfeed').appendChild(child);

        child.classList.add('animate__animated', 'animate__fadeInLeft');

        setTimeout(function() {
            child.classList.add('animate__animated', 'animate__fadeOutRight');

            child.addEventListener('animationend', () => {
                child.remove();
            });
        }, 4000);
    }

    function addDemoEvent(player1, team_color1, player2, team_color2) {
        var html = `
            <p style="background-color: ${team_color1} !important;">${player1}</p>
            <p class="match-event-name">DEMO</p>
            <p style="background-color: ${team_color2} !important;" class="match-border">${player2}</p>`;
        var child = document.createElement('div');
        child.classList.add('row', 'match-event');
        child.innerHTML = html;
        document.getElementById('match-statfeed').appendChild(child);

        child.classList.add('animate__animated', 'animate__fadeInLeft');

        setTimeout(function() {
            child.classList.add('animate__animated', 'animate__fadeOutRight');

            child.addEventListener('animationend', () => {
                child.remove();
            });
        }, 4000);
    }

    $(() => {
        Relay.addListener("status_changed", (data) => {
            if(data["status"] === "INITIALIZED") {
                
                // match-replay
                Relay.socket.on("update state", (match) => {
                    let game = match["game"];
                    if(!game["hasGame"]) 
                        document.getElementById("match-speeddiv").style.marginTop = "-40px";
                });

                // match-replay
                Relay.socket.on("game event", (ev) => {
                    if(ev["event"] === "game:replay_end"){
                        document.getElementById('match-speeddiv').style.marginTop = "-40px";
                    } else if(ev["event"] === "game:goal_scored") {
                        let data = ev["data"];
                        match_lastGoal = data['scorer']['id'];
                        document.getElementById('match-goal-speed').innerText = "Goal Speed: " + (data["goalspeed"]*0.621371).toFixed(0) + " MPH";
                        
                        setTimeout(() => {
                            document.getElementById('match-speeddiv').style.marginTop = "0px";
                        }, 3000);
                    }
                });

                // match-statfeed
                Relay.socket.on("game event", (ev) => {
                    if(ev["event"] === "game:statfeed_event") {
                        var data = ev["data"];
                        var stat = match_displayConversionMap[data["type"]] || data["type"];

                        if(stat === "Demo") {
                            let { player: mainPlayer, team: mainTeam } = findPlayer(data['main_target']['id']);
                            let { player: secondaryTarget, team: secondaryTeam } = findPlayer(data['secondary_target']['id']);
                            addDemoEvent(data['main_target']['name'], mainTeam === "homeTeam" ? match_homeTeamPrimary : match_awayTeamPrimary, data['secondary_target']['name'], secondaryTeam === "homeTeam" ? match_homeTeamPrimary : match_awayTeamPrimary);
                        } else {
                            let { player, team } = findPlayer(data['main_target']['id']);
                            addEvent(data['main_target']['name'], team === "homeTeam" ? match_homeTeamPrimary : match_awayTeamPrimary, stat);
                        }
                    }
                })

                // match-statfeed
                Relay.socket.on("update state", (match) => {
                    lastGame = match["game"];
                    if(match["game"] && match["game"]["homeTeam"]) {
                        match_homeTeamPrimary = match["game"]["homeTeam"]["colors"]["homePrimary"];
                        match_awayTeamPrimary = match["game"]["awayTeam"]["colors"]["awayPrimary"];
                        match_homeTeamSecondary = match["game"]["homeTeam"]["colors"]["homeSecondary"];
                        match_awayTeamSecondary = match["game"]["awayTeam"]["colors"]["awaySecondary"];
                    }
                });

                // match-details
                Relay.socket.on("update state", (match) => {
                    let game = match["game"];
                    if(!game["hasGame"]) {
                        document.getElementById("match-details").style.display = "none";
                    } else {
                        var clock = (game['isOT'] ? '+' : '') + secondsToTime(game["time"], game["time"] <= 60 && !game["isOT"]);
                        document.getElementById("match-clockp").innerText = clock;
                        document.querySelector("#match-hteam > p").innerText = game["homeTeam"]["score"];
                        document.querySelector("#match-ateam > p").innerText = game["awayTeam"]["score"];
                        document.getElementById("match-hteam").style.backgroundColor = game["homeTeam"]["colors"]["homePrimary"];
                        document.getElementById("match-ateam").style.backgroundColor = game["awayTeam"]["colors"]["homePrimary"];
                        document.getElementById("match-hteam").style.color = game["homeTeam"]["colors"]["homeSecondary"];
                        document.getElementById("match-ateam").style.color = game["awayTeam"]["colors"]["homeSecondary"];
                        
                        var homeName = game["homeTeam"]["name"];
                        var awayName = game["awayTeam"]["name"];

                        document.querySelector('#match-hteam > div > p').innerText = homeName;
                        document.querySelector('#match-ateam > div > p').innerText = awayName;

                        document.querySelector("#match-hteam > img").src = game["homeTeam"]["avatar"];
                        document.querySelector("#match-ateam > img").src = game["awayTeam"]["avatar"];
                        document.getElementById("match-hteam-series").innerHTML = "";
                        document.getElementById("match-ateam-series").innerHTML = "";
                        
                        let stw = Math.ceil(match["bestOf"] / 2);
                        for(var i = 1; i <= stw; i++){
                            if(game["homeTeam"]["series"] >= i) {
                                document.getElementById('match-hteam-series').innerHTML += '<div class="match-series match-series-active"></div>';
                            } else {
                                document.getElementById('match-hteam-series').innerHTML += '<div class="match-series match-series-inactive"></div>';
                            }
                            if(game["awayTeam"]["series"] >= i) {
                                document.getElementById('match-ateam-series').innerHTML += '<div class="match-series match-series-active"></div>';
                            } else {
                                document.getElementById('match-ateam-series').innerHTML += '<div class="match-series match-series-inactive"></div>';
                            }
                        }
                    }
                });

                // match-details
                Relay.socket.emit("get match info", (match, err) => {
                    if(!err) {
                        // show scoreboard if match already started
                        if(match["game"]["time"] < 300) {
                            document.getElementById("match-details").style.display = "flex";
                            document.getElementById("match-clockdiv").style.marginBottom = "0px";
                        }
                    }
                });

                // match-details
                Relay.socket.on("game event", (ev) => {
                    if(ev["event"] === "game:match_ended") {
                        document.getElementById("match-clockdiv").style.marginBottom = "-70px";
                        animateCSS("#match-details", "fadeOut").then((message) => {
                            document.getElementById('match-details').style.display = "none";
                        });
                    } else if(ev["event"] === "game:initialized") {
                        document.getElementById("match-details").style.display = "flex";
                        animateCSS("#match-details", "fadeIn").then(() => {
                            document.getElementById("match-clockdiv").style.marginBottom = "0px";
                        });
                    }
                });

                // match-player
                Relay.socket.on("update state", (match) => {
                    let game = match["game"];
                    if(game["hasGame"]) {
                        if(!game["hasTarget"])
                            document.getElementById("match-player").style.display = "none";
                        else if(game["hasWinner"])
                            document.getElementById("match-player").style.display = "none";
                        else {
                            document.getElementById("match-player").style.display = "block";
                            var { player, team } = game["isReplay"] ? findPlayer(match_lastGoal) : findPlayer(game["target"]);

                            let html = `
                                <img src="${match["game"][team]["avatar"]}" alt="" style="filter: drop-shadow(0 0 1rem #000);" />
                                <p>${player['name']}</p>
                                <div id="match-player-tags">
                                    <p>GOALS</p>
                                    <p>ASSISTS</p>
                                    <p>SAVES</p>
                                    <p>SHOTS</p>
                                    <p>SCORE</p>
                                </div>
                                <div id="match-player-details">
                                    <p>${player['goals']}</p>
                                    <p>${player['assists']}</p>
                                    <p>${player['saves']}</p>
                                    <p>${player['shots']}</p>
                                    <p>${player['score']}</p>
                                </div>
                            `;
                            document.getElementById('match-player').innerHTML = html;
                            document.getElementById('match-player').style.backgroundColor = match["game"][team]["colors"]["homePrimary"];
                            document.getElementById('match-player').style.color = match["game"][team]["colors"]["homeSecondary"];
                            document.getElementById('match-player-tags').style.color = match["game"][team]["colors"]["homePrimary"];
                            document.getElementById('match-player-tags').style.backgroundColor = match["game"][team]["colors"]["homeSecondary"];
                            document.getElementById('match-player-details').style.color = match["game"][team]["colors"]["homeSecondary"];
                        }
                    }
                    else 
                        document.getElementById("match-player").style.display = "none";

                });

                // match-boost
                Relay.socket.on("update state", (match) => {
                    let game = match["game"];
                    if((!game["hasTarget"] && !game["isReplay"]) || game["hasWinner"]) {
                        document.getElementById("match-boost").style.display = "none";
                    } else {
                        document.getElementById("match-boost").style.display = "block";
                        if(game["isReplay"]) {
                            var boost = document.querySelector('match-boost');
                            var { player, team } = findPlayer(match_lastGoal);
                            boost.setBoost(player['boost']);
                            boost.setPrimaryColor(game[team]["colors"]["homeSecondary"]);
                            boost.setSecondaryColor(game[team]["colors"]["homePrimary"]);
                            boost.setTeamLogo(game[team]["avatar"]);
                        } else if(game["hasTarget"]) {
                            var boost = document.querySelector('match-boost');
                            var { player, team } = findPlayer(game["target"]);
                            boost.setBoost(player['boost']);
                            boost.setPrimaryColor(game[team]["colors"]["homeSecondary"]);
                            boost.setSecondaryColor(game[team]["colors"]["homePrimary"]);
                            boost.setTeamLogo(game[team]["avatar"]);
                        }
                    }
                });

                // match-boost
                Relay.socket.on("game event", (data) => {
                    if(data["event"] === "game:goal_scored") {
                        match_lastGoal = data["data"]["scorer"]["id"];
                    }
                });
            }
        });
    });
</script>